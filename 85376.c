RendererSchedulerImpl::MainThreadOnly::MainThreadOnly(
    RendererSchedulerImpl* renderer_scheduler_impl,
    const scoped_refptr<MainThreadTaskQueue>& compositor_task_runner,
    base::TickClock* time_source,
    base::TimeTicks now)
    : loading_task_cost_estimator(time_source,
                                  kLoadingTaskEstimationSampleCount,
                                  kLoadingTaskEstimationPercentile),
      timer_task_cost_estimator(time_source,
                                kTimerTaskEstimationSampleCount,
                                kTimerTaskEstimationPercentile),
      idle_time_estimator(compositor_task_runner,
                          time_source,
                          kShortIdlePeriodDurationSampleCount,
                          kShortIdlePeriodDurationPercentile),
      current_use_case(UseCase::kNone,
                       "RendererScheduler.UseCase",
                       renderer_scheduler_impl,
                       &renderer_scheduler_impl->tracing_controller_,
                       UseCaseToString),
      longest_jank_free_task_duration(
          base::TimeDelta(),
          "RendererScheduler.LongestJankFreeTaskDuration",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          TimeDeltaToMilliseconds),
      renderer_pause_count(0,
                           "RendererScheduler.PauseCount",
                           renderer_scheduler_impl,
                           &renderer_scheduler_impl->tracing_controller_),
      navigation_task_expected_count(
          0,
          "RendererScheduler.NavigationTaskExpectedCount",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_),
      expensive_task_policy(ExpensiveTaskPolicy::kRun,
                            "RendererScheduler.ExpensiveTaskPolicy",
                            renderer_scheduler_impl,
                            &renderer_scheduler_impl->tracing_controller_,
                            ExpensiveTaskPolicyToString),
      rail_mode_for_tracing(current_policy.rail_mode(),
                            "RendererScheduler.RAILMode",
                            renderer_scheduler_impl,
                            &renderer_scheduler_impl->tracing_controller_,
                            RAILModeToString),
      renderer_hidden(false,
                      "RendererScheduler.Hidden",
                      renderer_scheduler_impl,
                      &renderer_scheduler_impl->tracing_controller_,
                      HiddenStateToString),
      renderer_backgrounded(kLaunchingProcessIsBackgrounded,
                            "RendererScheduler.Backgrounded",
                            renderer_scheduler_impl,
                            &renderer_scheduler_impl->tracing_controller_,
                            BackgroundStateToString),
      stopping_when_backgrounded_enabled(
          false,
          "RendererScheduler.StoppingWhenBackgroundedEnabled",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          YesNoStateToString),
      stopped_when_backgrounded(false,
                                "RendererScheduler.StoppedWhenBackgrounded",
                                renderer_scheduler_impl,
                                &renderer_scheduler_impl->tracing_controller_,
                                YesNoStateToString),
      was_shutdown(false,
                   "RendererScheduler.WasShutdown",
                   renderer_scheduler_impl,
                   &renderer_scheduler_impl->tracing_controller_,
                   YesNoStateToString),
      loading_task_estimated_cost(
          base::TimeDelta(),
          "RendererScheduler.LoadingTaskEstimatedCostMs",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          TimeDeltaToMilliseconds),
      timer_task_estimated_cost(base::TimeDelta(),
                                "RendererScheduler.TimerTaskEstimatedCostMs",
                                renderer_scheduler_impl,
                                &renderer_scheduler_impl->tracing_controller_,
                                TimeDeltaToMilliseconds),
      loading_tasks_seem_expensive(
          false,
          "RendererScheduler.LoadingTasksSeemExpensive",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          YesNoStateToString),
      timer_tasks_seem_expensive(false,
                                 "RendererScheduler.TimerTasksSeemExpensive",
                                 renderer_scheduler_impl,
                                 &renderer_scheduler_impl->tracing_controller_,
                                 YesNoStateToString),
      touchstart_expected_soon(false,
                               "RendererScheduler.TouchstartExpectedSoon",
                               renderer_scheduler_impl,
                               &renderer_scheduler_impl->tracing_controller_,
                               YesNoStateToString),
      have_seen_a_begin_main_frame(
          false,
          "RendererScheduler.HasSeenBeginMainFrame",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          YesNoStateToString),
      have_reported_blocking_intervention_in_current_policy(
          false,
          "RendererScheduler.HasReportedBlockingInterventionInCurrentPolicy",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          YesNoStateToString),
      have_reported_blocking_intervention_since_navigation(
          false,
          "RendererScheduler.HasReportedBlockingInterventionSinceNavigation",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          YesNoStateToString),
      has_visible_render_widget_with_touch_handler(
          false,
          "RendererScheduler.HasVisibleRenderWidgetWithTouchHandler",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          YesNoStateToString),
      begin_frame_not_expected_soon(
          false,
          "RendererScheduler.BeginFrameNotExpectedSoon",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          YesNoStateToString),
      in_idle_period_for_testing(false,
                                 "RendererScheduler.InIdlePeriod",
                                 renderer_scheduler_impl,
                                 &renderer_scheduler_impl->tracing_controller_,
                                 YesNoStateToString),
      use_virtual_time(false,
                       "RendererScheduler.UseVirtualTime",
                       renderer_scheduler_impl,
                       &renderer_scheduler_impl->tracing_controller_,
                       YesNoStateToString),
      is_audio_playing(false,
                       "RendererScheduler.AudioPlaying",
                       renderer_scheduler_impl,
                       &renderer_scheduler_impl->tracing_controller_,
                       AudioPlayingStateToString),
      compositor_will_send_main_frame_not_expected(
          false,
          "RendererScheduler.CompositorWillSendMainFrameNotExpected",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          YesNoStateToString),
      has_navigated(false,
                    "RendererScheduler.HasNavigated",
                    renderer_scheduler_impl,
                    &renderer_scheduler_impl->tracing_controller_,
                    YesNoStateToString),
      pause_timers_for_webview(false,
                               "RendererScheduler.PauseTimersForWebview",
                               renderer_scheduler_impl,
                               &renderer_scheduler_impl->tracing_controller_,
                               YesNoStateToString),
      background_status_changed_at(now),
      rail_mode_observer(nullptr),
      wake_up_budget_pool(nullptr),
      metrics_helper(renderer_scheduler_impl, now, renderer_backgrounded),
      process_type(RendererProcessType::kRenderer,
                   "RendererScheduler.ProcessType",
                   renderer_scheduler_impl,
                   &renderer_scheduler_impl->tracing_controller_,
                   RendererProcessTypeToString),
      task_description_for_tracing(
          base::nullopt,
          "RendererScheduler.MainThreadTask",
          renderer_scheduler_impl,
          &renderer_scheduler_impl->tracing_controller_,
          OptionalTaskDescriptionToString),
      virtual_time_policy(VirtualTimePolicy::kAdvance),
      virtual_time_pause_count(0),
      max_virtual_time_task_starvation_count(0),
      virtual_time_stopped(false),
      nested_runloop(false) {}
